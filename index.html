<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FormBuilder Copilot UI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app-wrapper">
      <nav class="navbar navbar-expand-lg border-bottom bg-white">
        <div class="container-fluid px-4">
          <span class="navbar-brand fw-semibold">FormBuilder Copilot</span>
          <div class="ms-auto">
            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="capturePreviewBtn">
              Capture preview
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
              Settings
            </button>
          </div>
        </div>
      </nav>
      <header class="app-header border-bottom d-none">
        <div class="container-fluid px-4 py-3">
          <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3">
            <div>
              <p class="text-uppercase text-muted small mb-1">FormBuilder Copilot</p>
              <h1 class="h3 mb-2">AI-assisted form preview</h1>
              <p class="mb-0 text-muted">
                Chat with the backend agent, validate catalog compliant changes, and refresh the Bootstrap preview that
                always reflects the persisted HTML.
              </p>
            </div>
            <div class="text-lg-end">
              <div id="connectionStatus" class="fw-semibold small text-success">Ready</div>
              <div class="small text-muted">Session: <span id="sessionId"></span></div>
              <div class="small text-muted">
                Frontend <span id="frontendVersion">—</span> · API <span id="apiVersion">—</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="app-main container-fluid py-4">
        <div class="row g-4 flex-grow-1">
          <div class="col-12 col-lg-4 d-flex">
            <section id="chatPane" class="pane card shadow-sm flex-grow-1">
              <div class="card-body d-flex flex-column gap-4">
                <div>
                  <form id="connectionForm" class="connection-form">
                    <div class="row g-2 d-none">
                      <div class="col-6">
                        <label for="tenantId" class="form-label">Tenant ID</label>
                        <input type="text" id="tenantId" class="form-control" placeholder="demo" />
                      </div>
                      <div class="col-6">
                        <label for="formId" class="form-label">Form ID</label>
                        <input type="text" id="formId" class="form-control" placeholder="contactform" />
                      </div>
                    </div>
                    <div class="mt-3 d-none">
                      <label for="formName" class="form-label">Page Name</label>
                      <input type="text" id="formName" class="form-control" placeholder="Contact Page" />
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-3 d-none">
                      <button type="button" class="btn btn-outline-primary" id="createFormBtn">Create form</button>
                      <button type="button" class="btn btn-outline-secondary" id="loadPreviewBtn">
                        Load preview
                      </button>
                    </div>
                    <div id="connectionFeedback" class="form-text mt-2"></div>
                  </form>
                </div>

                <div class="d-flex flex-column flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                      <h2 class="h5 mb-1">AI Chat</h2>
                      <p class="text-muted small mb-0">
                        Describe the change you'd like. The backend validates every tool call before updating the
                        preview.
                      </p>
                    </div>
                    <span id="chatModelBadge" class="badge text-bg-secondary">model</span>
                  </div>
                  <div id="chatLog" class="chat-log flex-grow-1 border rounded"></div>
                  <div id="chatError" class="alert alert-danger mt-3 mb-0 d-none" role="alert"></div>
                  <form id="chatForm" class="chat-form mt-3">
                    <label for="chatMessage" class="form-label fw-semibold">Message</label>
                    <textarea
                      id="chatMessage"
                      class="form-control"
                      rows="3"
                      placeholder="Example: Add a select input for inquiry type"
                      required
                    ></textarea>
                    <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                      <div class="form-text flex-grow-1" id="chatHint">
                        Tenant and form selection is required before sending a message.
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light btn-sm" id="clearChatBtn">Clear</button>
                        <button type="submit" class="btn btn-primary" id="sendMessageBtn" disabled>
                          <span class="spinner-border spinner-border-sm d-none me-2" id="chatSpinner"></span>
                          Send
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </section>
          </div>

          <div class="col-12 col-lg-8 d-flex">
            <section id="previewPane" class="pane card shadow-sm flex-grow-1">
              <div class="card-body d-flex flex-column gap-4">
                <div class="d-flex flex-wrap justify-content-between gap-2 d-none">
                  <div>
                    <h2 class="h5 mb-1">Preview</h2>
                    <p class="small text-muted mb-0">
                      Renders the latest backend-persisted HTML using Bootstrap 5.
                    </p>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshPreviewBtn">
                      Refresh preview
                    </button>
                  </div>
                </div>
                <div id="metadataPanel" class="metadata d-none"></div>
                <div id="validationPanel" class="d-none">
                  <div class="alert alert-warning mb-0">
                    <div class="fw-semibold mb-2">Validation messages</div>
                    <ul id="validationMessages" class="mb-0"></ul>
                  </div>
                </div>
                <div class="preview-body flex-grow-1">
                  <div id="previewStatus" class="text-muted small mb-3">Preview not loaded.</div>
                  <div id="previewContainer" class="preview-container"></div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="settingsModalLabel">Settings</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="apiBaseUrl" class="form-label">API Base URL</label>
            <input
              type="url"
              id="apiBaseUrl"
              class="form-control"
              placeholder="http://localhost:5000"
              autocomplete="url"
            />
            <div class="form-text mt-2">Changes apply immediately to the chat and preview.</div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
      integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H"
      crossorigin="anonymous"
    ></script>
    <script type="module" src="./app.js"></script>
  </body>
</html>
